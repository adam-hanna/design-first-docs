

<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.9.0">
    <title>Context — design-first</title>
    <meta charset="utf-8">
    <meta name="description" content="design-first - A tool for building better http REST api's, faster">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="alternate" hreflang="x-default" href="https://adam-hanna.github.io/design-first-docs/v0/guide/context.html">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Context — design-first">
    <meta property="og:description" content="design-first - A tool for building better http REST api's, faster">
    <meta property="og:image" content="https://adam-hanna.github.io//design-first-docs/images/logo.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Context — design-first">
    <meta name="twitter:description" content="design-first - A tool for building better http REST api's, faster">
    <meta name="twitter:image" content="https://adam-hanna.github.io/images/logo.png">

    <!--
    <link rel="apple-touch-icon" sizes="57x57" href="/design-first-docs/images/icons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/design-first-docs/images/icons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/design-first-docs/images/icons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/design-first-docs/images/icons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/design-first-docs/images/icons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/design-first-docs/images/icons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/design-first-docs/images/icons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/design-first-docs/images/icons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/design-first-docs/images/icons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/design-first-docs/images/icons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/design-first-docs/images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/design-first-docs/images/icons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/design-first-docs/images/icons/favicon-16x16.png">
    <meta name="msapplication-TileImage" content="/images/icons/ms-icon-144x144.png">
    -->
    <link rel="icon" href="/design-first-docs/images/logo.png" type="image/png">

    <meta name="msapplication-TileColor" content="#4fc08d">
    <meta name="theme-color" content="#4fc08d">

    <meta name="msapplication-config" content="browserconfig.xml">
    <link rel="manifest" href="/manifest.json">

    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Roboto Mono" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Dosis:500&text=Vue.js" rel="stylesheet" type="text/css">

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- main page styles -->
    <link rel="stylesheet" href="/design-first-docs/css/page.css">

    <!-- this needs to be loaded before guide's inline scripts -->
    <!--
    <script src="/design-first-docs/js/vue.js"></script>
    <script>
      Vue.config.productionTip = false
      window.PAGE_TYPE = "guide"
    </script>
    -->

  </head>
  <body class="docs">
    <div id="mobile-bar">
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>
    <div id="header">
  <a id="logo" href="/design-first-docs/">
    <img src="/design-first-docs/images/logo.png" alt="design-first logo">
    <span>design-first</span>
  </a>
  <ul id="nav">
    <li>
  <!--
  <form id="search-form">
    <input type="text" id="search-query-nav" class="search-query st-default-search-input">
  </form>
  -->
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link current">Learn</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><h4>Documentation</h4></li>
    <li>
      <ul>
        <li><a href="/design-first-docs/v0/guide/" class="nav-link current">Guide</a></li>
        <li><a href="/design-first-docs/v0/examples/" class="nav-link">Examples</a></li>
      </ul>
    </li>
  </ul>
</li>


  </ul>
</div>

    
      <div id="main" class="fix-sidebar">
        
          
  <div class="sidebar">
  <div class="sidebar-inner">
    <ul class="main-menu">
      <li>
  <!--
  <form id="search-form">
    <input type="text" id="search-query-sidebar" class="search-query st-default-search-input">
  </form>
  -->
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link current">Learn</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><h4>Documentation</h4></li>
    <li>
      <ul>
        <li><a href="/design-first-docs/v0/guide/" class="nav-link current">Guide</a></li>
        <li><a href="/design-first-docs/v0/examples/" class="nav-link">Examples</a></li>
      </ul>
    </li>
  </ul>
</li>


    </ul>
    <div class="list">
      
        <h2>
          
          Guide
          
            <select class="version-select">
              <option value="SELF" selected>0.x</option>
              <!--
              <option value="v1">1.0</option>
              <option value="012">0.12</option>
              <option value="011">0.11</option>
              -->
            </select>
          
        </h2>
        <ul class="menu-root">
  
    
    
      
        <li><h3>Essentials</h3></li>
      
      
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/installation.html" class="sidebar-link">Installation</a>
    </li>
  
    
    
      
      
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/index.html" class="sidebar-link">Introduction</a>
    </li>
  
    
    
      
      
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/context.html" class="sidebar-link current">Context</a>
    </li>
  
    
    
      
      
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/payloads.html" class="sidebar-link">Payloads</a>
    </li>
  
    
    
      
      
        <li><h3>Command Line</h3></li>
      
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/command-line.html" class="sidebar-link">CLI</a>
    </li>
  
    
    
      
      
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/command-line-init.html" class="sidebar-link">Initialize</a>
    </li>
  
    
    
      
      
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/command-line-gen.html" class="sidebar-link">Generate</a>
    </li>
  
    
    
      
      
      
        <li><h3>Directory Structure</h3></li>
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/directory-structure.html" class="sidebar-link">Tree</a>
    </li>
  
    
    
      
      
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/directory-structure-authentication.html" class="sidebar-link">Authentication</a>
    </li>
  
    
    
      
      
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/directory-structure-authorization.html" class="sidebar-link">Authorization</a>
    </li>
  
    
    
      
      
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/directory-structure-context.html" class="sidebar-link current">Context</a>
    </li>
  
    
    
      
      
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/directory-structure-handlers.html" class="sidebar-link">Handlers</a>
    </li>
  
    
    
      
      
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/directory-structure-internal.html" class="sidebar-link">Internal</a>
    </li>
  
    
    
      
      
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/directory-structure-middleware.html" class="sidebar-link">Middleware</a>
    </li>
  
    
    
      
      
      
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/directory-structure-models.html" class="sidebar-link">Models</a>
    </li>
  
    
    
      
      
      
      
        <li><h3>Design File</h3></li>
      
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/design-file.html" class="sidebar-link">design.json</a>
    </li>
  
    
    
      
      
      
      
      
        <li><h3>Models</h3></li>
      
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/models.html" class="sidebar-link">Models</a>
    </li>
  
    
    
      
      
      
      
      
      
        <li><h3>Concerns</h3></li>
      
      
    
    <li>
      <a href="/design-first-docs/v0/guide/concerns.html" class="sidebar-link">Concerns</a>
    </li>
  
    
    
      
      
      
      
      
      
      
        <li><h3>Meta</h3></li>
      
    
    <li>
      <a href="/design-first-docs/v0/guide/team.html" class="sidebar-link">Meet the Team</a>
    </li>
  
</ul>

      
    </div>
  </div>
</div>


<div class="content guide with-sidebar context-guide">
  
    
      <!--
<div id="ad">
  <script
    async
    type="text/javascript"
    src="//cdn.carbonads.com/carbon.js?serve=CKYIK2QU&placement=vuejsorg"
    id="_carbonads_js">
  </script>
</div>
-->

    
  
  
    <h1>Context</h1>
  
  
    <p>Contexts are used in http servers to pass data and methods along with requests are responses. For example, an authorization function may need to access information that results from the authentication function (such as a userID, for example). This information can be passed to the authorization function, along with the request and response, in a context.</p>
<p>There are two types of contexts used in a design-first api: application wide and request restricted.</p>
<h2 id="Application-Context"><a href="#Application-Context" class="headerlink" title="Application Context"></a>Application Context</h2><p>Application context is set once when the app starts and is avaialble to all authentication, authorization and handler functions in a design-first api.</p>
<p>A common use for application context is to attach database connections, for example.</p>
<p>Application context is declared in <code>./src/context/app/index.ts</code> and is initialized in <code>./src/server.ts</code>. An example follows.</p>
<p><strong>./src/db/index.ts</strong><br><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> &#123; resolve &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;
<span class="hljs-keyword">import</span> &#123; Pool &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'pg'</span>;
<span class="hljs-keyword">import</span> &#123; migrate &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'postgres-migrations'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> &#123;
  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> user: <span class="hljs-built_in">string</span>, <span class="hljs-keyword">private</span> password: <span class="hljs-built_in">string</span>, <span class="hljs-keyword">private</span> host: <span class="hljs-built_in">string</span>, <span class="hljs-keyword">private</span> database: <span class="hljs-built_in">string</span>, <span class="hljs-keyword">private</span> port: <span class="hljs-built_in">number</span></span>) &#123;
    <span class="hljs-keyword">this</span>.pool = <span class="hljs-keyword">new</span> Pool(&#123;
      user,
      host,
      database,
      password,
      port,
    &#125;)
  &#125;

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> doesUserOwnFoo (todoID: <span class="hljs-built_in">string</span>, userID: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; &#123;
    ...
  &#125;

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> migrate () &#123;
    <span class="hljs-keyword">await</span> migrate(&#123;
      user: <span class="hljs-keyword">this</span>.user,
      password: <span class="hljs-keyword">this</span>.password,
      host: <span class="hljs-keyword">this</span>.host,
      database: <span class="hljs-keyword">this</span>.database,
      port: <span class="hljs-keyword">this</span>.port,
    &#125;, resolve(__dirname, <span class="hljs-string">'./migrations/'</span>), <span class="hljs-literal">undefined</span>);
  &#125;

  <span class="hljs-keyword">private</span> pool: Pool
&#125;</code></pre></p>
<p><strong>./src/context/app/index.ts</strong><br><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> DB <span class="hljs-keyword">from</span> <span class="hljs-string">'../../db'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> appContext &#123;
  <span class="hljs-comment">// note: add your app-wide context, here</span>
  db: DB;
&#125;</code></pre></p>
<p><strong>./src/server.ts</strong><br><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> DB <span class="hljs-keyword">from</span> <span class="hljs-string">'./db'</span>;

<span class="hljs-comment">// Create the db</span>
<span class="hljs-keyword">const</span> db: DB = <span class="hljs-keyword">new</span> DB(
  process.env.POSTGRES_USER,
  process.env.POSTGRES_PASSWORD,
  process.env.POSTGRES_HOST,
  process.env.POSTGRES_DATABASE,
  <span class="hljs-built_in">parseInt</span>(process.env.POSTGRES_PORT),
);

<span class="hljs-keyword">let</span> appCtx: appContext = <span class="hljs-keyword">new</span> appContext();
appCtx.db = db;
app.set(<span class="hljs-string">'context'</span>, appCtx);

<span class="hljs-comment">/**
 * Primary app routes.
 */</span>
app.use(<span class="hljs-string">'/'</span>, routes);

<span class="hljs-comment">/**
 *  * Start Express server.
 */</span>
<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">async</span> () =&gt; &#123;
  <span class="hljs-comment">// Migrate the db.</span>
  <span class="hljs-keyword">try</span> &#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'migrating db'</span>);
    <span class="hljs-keyword">await</span> db.migrate();
  &#125; <span class="hljs-keyword">catch</span> (e) &#123;
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'err migrating the database\n'</span>, e);
    process.exit(<span class="hljs-number">1</span>);
  &#125;

  app.listen(app.get(<span class="hljs-string">'port'</span>), app.get(<span class="hljs-string">'host'</span>), <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;
    <span class="hljs-built_in">console</span>.log(
      <span class="hljs-string">'  App is running at http://%s:%d in %s mode'</span>,
      app.get(<span class="hljs-string">'host'</span>),
      app.get(<span class="hljs-string">'port'</span>),
      app.get(<span class="hljs-string">'env'</span>)
    );
    <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">'  Press CTRL-C to stop\n'</span>);
  &#125;);
&#125;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> server();</code></pre></p>
<p>And now you can use the methods exposed on the db class in your app. For example:</p>
<p><strong>./src/authorization/foos/show/index.ts</strong><br><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> &#123; Request, Response &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> appContext <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../context/app'</span>;
<span class="hljs-keyword">import</span> requestContext <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../context/request/foos/show'</span>;
<span class="hljs-keyword">import</span> &#123; HttpReturn &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../internal/utils'</span>;
<span class="hljs-keyword">import</span> &#123; ShowTodoPayload &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../models'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> (
  appCtx: appContext,
  requestCtx: requestContext,
  payload: ShowTodoPayload,
  req: Request,
  res: Response,
): <span class="hljs-built_in">Promise</span>&lt;HttpReturn | <span class="hljs-built_in">void</span>&gt; =&gt; &#123;
  <span class="hljs-keyword">if</span> (requestContext.isAdmin)
    <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">const</span> authorized = <span class="hljs-keyword">await</span> appCtx.db.doesUserOwnFoo(payload.fooID, requestContext.userID);
  <span class="hljs-keyword">if</span> (!authorized)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HttpReturn(<span class="hljs-number">401</span>, <span class="hljs-string">'unauthorized'</span>);
&#125;</code></pre></p>
<p>Notice that this authorization function takes advantage of the request context. We’ll discuss request context in the next section.</p>
<h2 id="Request-Context"><a href="#Request-Context" class="headerlink" title="Request Context"></a>Request Context</h2><p>Request context is scoped to each request and is created and destroyed each time a new request is received by the server. It can be used to pass information from the authentication to the authorization to the handler functions.</p>
<p>An example was shown in the previous section where the authorization function needed to know if the logged in user was an administrator and if not, what is the logged in user’s id. An example of how this could be done follows.</p>
<p>Request contexts should not have constructor functions.</p>
<p><strong>./src/context/request/foos/show/index.ts</strong><br><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> defaultRequestContext <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../request'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-keyword">extends</span> defaultRequestContext &#123;
  <span class="hljs-keyword">public</span> userID: <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">public</span> isAdmin: <span class="hljs-built_in">boolean</span>;
&#125;</code></pre></p>
<p><strong>./src/authentication/foos/show/index.ts</strong><br><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> &#123; Request, Response &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> appContext <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../context/app'</span>;
<span class="hljs-keyword">import</span> requestContext <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../context/request/foos/show'</span>;
<span class="hljs-keyword">import</span> &#123; HttpReturn &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../internal/utils'</span>;
<span class="hljs-keyword">import</span> &#123; ShowTodoPayload &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../models'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> (
  appCtx: appContext,
  requestCtx: requestContext,
  payload: ShowTodoPayload,
  req: Request,
  res: Response,
): <span class="hljs-built_in">Promise</span>&lt;HttpReturn | <span class="hljs-built_in">void</span>&gt; =&gt; &#123;
  <span class="hljs-comment">// check session</span>
  <span class="hljs-keyword">if</span> (!req.session.userID)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HttpReturn(<span class="hljs-number">401</span>, <span class="hljs-string">'unauthorized'</span>);

  requestCtx.isAdmin = req.session.isAdmin;
  requestCtx.userID = req.session.userID;
&#125;</code></pre></p>
<p>Note that the request context extends the <code>defaultRequestContext</code> which can be defined in <code>./src/context/request/index.ts</code>. This helps if you want some data to be available for every request without having to edit each individual requestContext.</p>

  
  
    <div class="guide-links">
      
      
        <span>← <a href="/design-first-docs/v0/guide/index.html">Introduction</a></span>
      
      
      
        <span style="float: right;"><a href="/design-first-docs/v0/guide/payloads.html">Payloads</a> →</span>
      
    </div>
  
  <div class="footer">
    Caught a mistake or want to contribute to the documentation?
    <a href="https://github.com/adam-hanna/design-first-docs/blob/master/src/v0/guide/context.md" target="_blank">
      Edit this page on GitHub!
    </a>
  </div>
</div>

        
      </div>
      <script src="/design-first-docs/js/smooth-scroll.min.js"></script>
    

    <!-- main custom script for sidebars, version selects etc. -->
    <script src="/design-first-docs/js/css.escape.js"></script>
    <script src="/design-first-docs/js/common.js"></script>

    <!-- search -->
    <!--
    <link href="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/design-first-docs/css/search.css">
    <script src="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <script>
    [
      '#search-query-nav',
      '#search-query-sidebar',
      '#search-query-menu'
    ].forEach(function (selector) {
      if (!document.querySelector(selector)) return
      // search index defaults to v2
      var match = window.location.pathname.match(/^\/(v\d+)/)
      var version = match ? match[1] : 'v2'
      docsearch({
      appId: 'BH4D9OD16A',
      apiKey: '85cc3221c9f23bfbaa4e3913dd7625ea',
      indexName: 'vuejs',
      inputSelector: selector,
      algoliaOptions: { facetFilters: ["version:" + version] },
      autocompleteOptions: { hint: false, appendTo: 'body'}
      })
    })
    </script>
    -->
  </body>
</html>
